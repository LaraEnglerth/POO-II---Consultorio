<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Procedimento - OdontoPrice</title>
  <link rel="stylesheet" href="./css/styles.css">
</head>
<body>
  <div class="app-container">
    <div id="sidebar"></div>
    <main class="main-content">
      <div class="container" style="max-width: 64rem;">
  <a href="./procedimentos.html" class="btn btn-ghost mb-4">Voltar</a>
        <div id="pageHeader"></div>
        <form id="form">
          <div class="card">
            <div class="card-header"><h2 class="card-title">Informações Básicas</h2></div>
            <div class="card-content">
              <div class="form-group">
                <label class="form-label">Nome <span class="form-required">*</span></label>
                <input type="text" id="nome_procedimento" class="form-input" required>
              </div>
              <div class="grid grid-cols-2">
                <div class="form-group">
                  <label class="form-label">Requer Assistente</label>
                  <select id="assistente" class="form-select">
                    <option value="N">Não</option>
                    <option value="S">Sim</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Duração (min) <span class="form-required">*</span></label>
                  <input type="number" id="duracao" class="form-input" step="0.1" min="0.1" required>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Paciente</label>
                <select id="pacienteId" class="form-select"></select>
              </div>
            </div>
              </div>

              
                <div class="card" style="margin-top: 1rem;">
                  <div class="card-header"><h2 class="card-title">Materiais Utilizados</h2></div>
                  <div class="card-content">
                    <div id="materiaisUtilizadosSection" class="grid grid-cols-3" style="align-items: end; gap: .5rem;">
                      <div class="form-group" style="margin:0;">
                        <label class="form-label">Material</label>
                        <select id="materialSelect" class="form-select"></select>
                      </div>
                      <div class="form-group" style="margin:0;">
                        <label class="form-label">Quantidade</label>
                        <input type="number" id="materialQuantidade" class="form-input" min="1" step="1" value="1">
                      </div>
                      <div style="margin:0;">
                        <button type="button" class="btn btn-outline" id="addMaterialBtn">Adicionar</button>
                      </div>
                    </div>

                    <div id="materiaisAdicionadosWrapper" style="margin-top:1rem;">
                      <label class="form-label">Materiais adicionados</label>
                      <ul id="materiaisList" class="list"></ul>
                      <small id="materiaisEmpty" class="muted">Nenhum material adicionado.</small>
                    </div>
                  </div>
                </div>
              



          <div class="card" id="VALORFINAL" style="margin-top: 1rem;">
            <div class="card-header"><h2 class="card-title">Valor Final</h2></div>
            <div class="card-content">
              <div class="flex gap-2">
                <div class="form-group" style="flex: 1; margin: 0;">
                  <input type="number" id="valorFinal" class="form-input" step="0.01" min="0">
                </div>
                <button type="button" class="btn btn-outline" id="BTNCALCULAR" onclick="calcularValor()">Calcular</button>
              </div>
            </div>
          </div>
          <div class="flex gap-2" style="margin-top: 1.5rem;">
            <button type="submit" class="btn btn-primary" id="submitBtn">Cadastrar</button>
            <a href="./procedimentos.html" class="btn btn-outline">Cancelar</a>
          </div>
          </div>


          
        </form>
      </div>
    </main>
  </div>
  <script src="./js/api.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/components.js"></script>
  <script>
    document.getElementById('sidebar').innerHTML = createSidebar('procedimentos');
    const id = getQueryParam('id');
    const mode = getQueryParam('mode');
    const isEdit = !!id;
    const isViewOnly = mode ==='view';
    
    document.getElementById('pageHeader').innerHTML = createPageHeader(
      isViewOnly ? 'Visualizar Procedimento'
      : isEdit ? 'Editar Procedimento'
      : 'Novo Procedimento',
      isViewOnly ? 'Detalhes do Procedimento'
      : 'Preencha os dados do procedimento'
    );

    const valorFinalCard = document.getElementById('VALORFINAL');
    const submitBtn2 = document.getElementById('BTNCALCULAR');
    
    if (!isEdit && valorFinalCard) {
      valorFinalCard.style.display = 'none';
    }
    if(isViewOnly) {
      submitBtn2.style.display = 'none';
    }

    if (isEdit && !isViewOnly) {
      document.getElementById('submitBtn').textContent = 'Atualizar';
    }
    function setReadOnlyMode() {
      const formElements = document.querySelectorAll(
        '#form input, #form select, #form textarea, #form button'
      );

      formElements.forEach(el => {
        if (el.id === 'submitBtn') return;
        if (el.closest('a.btn')) return;
        if (el.classList.contains('btn-ghost') && el.textContent.includes('Voltar')) return;
        el.disabled = true;
      });

      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.style.display = 'none';
      }

      const addMaterialBtn = document.getElementById('addMaterialBtn');
      if (addMaterialBtn) {
        addMaterialBtn.style.display = 'none';
      }

      window.removeMaterial = function () {
      };
    }

    if (isViewOnly) {
      setTimeout(setReadOnlyMode, 300);
    
      const matUtilizadosSection = document.getElementById('materiaisUtilizadosSection');
      if (matUtilizadosSection) {
        matUtilizadosSection.style.display = 'none';
      }

      const matAdicionadosWrapper = document.getElementById('materiaisAdicionadosWrapper');
      if (matAdicionadosWrapper) {
        matAdicionadosWrapper.style.marginTop = '0';
      }
    }


    // Materiais - UI e lógica
    let materiaisDisponiveis = [];
    let materiaisSelecionados = [];

    function renderMateriaisOptions() {
      const sel = document.getElementById('materialSelect');
      sel.innerHTML = materiaisDisponiveis.map(m =>
        `<option value="${m.id}" data-nome="${m.nomeMaterial}">${m.nomeMaterial} (disponível: ${m.quantidade})</option>`
      ).join('');
    }

    function renderMateriaisList() {
      const list = document.getElementById('materiaisList');
      const empty = document.getElementById('materiaisEmpty');
      if (materiaisSelecionados.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      list.innerHTML = materiaisSelecionados.map((m, idx) => {
        const nome = m.material ? (m.material.nomeMaterial || m.material.nome || 'Material') : (m.nomeMaterial || m.nome || 'Material');

        // Se estiver em modo visualização: só o nome
        if (isViewOnly) {
          return `
            <li class="list-item" style="list-style:none;justify-content:space-between;align-items:center;padding:.25rem 0;">
              <div>${nome}</div>
            </li>
          `;
        }

        // No modo normal (cadastro/edição): nome + quantidade + botão remover
        return `
          <li class="list-item" style="display:flex;justify-content:space-between;align-items:center;padding:.25rem 0;">
            <div>${nome} <small class="muted">x ${m.quantidade}</small></div>
            <div>
              <button type="button" class="btn btn-ghost" onclick="removeMaterial(${idx})">Remover</button>
            </div>
          </li>
        `;
      }).join('');

    }

    // Tornar a função global para uso no onclick inline
    window.removeMaterial = function(index) {
      materiaisSelecionados.splice(index, 1);
      renderMateriaisList();
    };

    document.getElementById('addMaterialBtn').addEventListener('click', () => {
      const sel = document.getElementById('materialSelect');
      const matId = sel.value;  // string
      const qtd = parseInt(document.getElementById('materialQuantidade').value, 10) || 0;
      if (!matId) {
        toast.error('Selecione um material');
        return;
      }
      if (qtd <= 0) {
        toast.error('Quantidade inválida');
        return;
      }
      const materialObj = materiaisDisponiveis.find(m => String(m.id) === String(matId));
      const nomeFromSelect =
        sel.options[sel.selectedIndex]?.dataset?.nome ||
        materialObj?.nomeMaterial ||
        'Material';
      const existing = materiaisSelecionados.find(m => String(m.materialId) === String(matId));
      if (existing) {
        existing.quantidade += qtd;
        existing.nomeMaterial = existing.nomeMaterial || nomeFromSelect;
      } else {
        materiaisSelecionados.push({
          materialId: matId,
          quantidade: qtd,
          material: materialObj || null,
          nomeMaterial: nomeFromSelect
        });
      }
      console.log("materiaisSelecionados depois de adicionar:", JSON.stringify(materiaisSelecionados, null, 2));
      renderMateriaisList();
    });

    // Carrega materiais disponíveis
    api.getMateriais().then(mats => {
      materiaisDisponiveis = mats || [];
      renderMateriaisOptions();
    });
    // Load pacientes
    api.getPacientes().then(pacientes => {
      const select = document.getElementById('pacienteId');
      select.innerHTML = '<option value="">Nenhum</option>' + pacientes.map(p => 
        `<option value="${p.id}">${p.nomePaciente}</option>`
      ).join('');
      
      if (isEdit) {
        api.getProcedimento(id).then(proc => {
          if (proc) {
            document.getElementById('nome_procedimento').value = proc.nomeProcedimento;
            document.getElementById('assistente').value = proc.assistente ? 'S' : 'N';
            document.getElementById('duracao').value = proc.duracao;
            document.getElementById('valorFinal').value = proc.valorFinal;
            document.getElementById('pacienteId').value = (proc.pacienteId ?? proc.paciente?.id ?? '');
            if (Array.isArray(proc.materiais)) {
              
              console.log("Materiais do procedimento (proc.materiais):", proc.materiais);

              materiaisSelecionados = proc.materiais.map(m => ({
                materialId: String(m.id),
                quantidade: m.quantidade,
                material: m,
                nomeMaterial: m.nomeMaterial
              }));

              renderMateriaisList();
            }
          }
        });
      }
    });
    
    function calcularValor() {
      const duracao = parseFloat(document.getElementById('duracao').value) || 0;
      const assistente = document.getElementById('assistente').value;
      let total = duracao * (100 / 60);
      if (assistente === 'S') total += 50;
      document.getElementById('valorFinal').value = total.toFixed(2);
      toast.success('Valor calculado');
    }
    
    document.getElementById('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Salvando...';
      
      try {
        const data = {
          nome_procedimento: document.getElementById('nome_procedimento').value.trim(),
          assistente: document.getElementById('assistente').value,
          duracao: parseFloat(document.getElementById('duracao').value),
          valorFinal: 1,
          pacienteId: document.getElementById('pacienteId').value || undefined,
          materiais: materiaisSelecionados.map(m => ({ materialId: m.materialId, quantidade: m.quantidade }))
        };
        
        if (isEdit) {
          await api.updateProcedimento(id, data);
          toast.success('Procedimento atualizado');
        } else {
          await api.createProcedimento(data);
          toast.success('Procedimento cadastrado');
        }
  window.location.href = './procedimentos.html';
      } catch (error) {
        toast.error('Erro ao salvar');
        btn.disabled = false;
        btn.textContent = isEdit ? 'Atualizar' : 'Cadastrar';
      }
    });
  </script>
</body>
</html>
